# 2024-NC2-A18-Widgets-FaHe

## 달아달아 
 <img src="https://github.com/DeveloperAcademy-POSTECH/2024-NC2-A18-Widgets/assets/121593683/2061f331-869c-4de8-b99b-9e70eb0068e3" width="256">

달에 사는 여우는 햇빛이 가려지는 순간 힘을 발휘할 수 있습니다. 월식이 일어나는 날, 달을 향해 소원을 빌면 여우가 소원을 들어줍니다. 

- 잠금화면 및 홈화면 위젯을 통해 다음 월식까지 남은 일수를 보여줍니다.
 
   <img width="305" alt="image" src="https://github.com/DeveloperAcademy-POSTECH/2024-NC2-A18-Widgets/assets/121593683/1774e045-e1ca-462a-8622-ec7aac9c4fec">
   
   <img width="305" alt="image" src="https://github.com/DeveloperAcademy-POSTECH/2024-NC2-A18-Widgets/assets/121593683/a03129a3-a130-4422-b90f-454602a0b419">


- 다이니믹 아일랜드를 이용해서 월식 진행 현황을 파악할 수 있습니다. 
<img width="426" alt="image" src="https://github.com/DeveloperAcademy-POSTECH/2024-NC2-A18-Widgets/assets/121593683/11eeb43d-23e0-4e06-9606-a93e20cc4bf8">
<img width="426" alt="image" src="https://github.com/DeveloperAcademy-POSTECH/2024-NC2-A18-Widgets/assets/121593683/95828113-d266-44b5-a26c-e9c0ffd2cfec">


- 월식이 시작시 월식 진행 현황을 잠금화면 라이브 액티비티를 통해 알 수 있습니다.
<img width="305" alt="image" src="https://github.com/DeveloperAcademy-POSTECH/2024-NC2-A18-Widgets/assets/121593683/9a281da8-26ac-4b01-a01c-4e07c90d93ea">


## 팀원 소개 

<table style="width: 100%; table-layout: fixed;">
  <tr>
    <td style="text-align: center; padding: 10px;">
      <h3>파인</h3>
    </td>
    <td style="text-align: center; padding: 10px;">
      <h3>헤이즐</h3>
    </td>
  </tr>
  <tr>
    <td style="text-align: center; padding: 10px;">
      <img src="https://github.com/DeveloperAcademy-POSTECH/2024-NC2-A18-Widgets/assets/121593683/ced8345c-a8a8-43fd-8312-9123a46baa65" width="256" alt="Image 1">
    </td>
    <td style="text-align: center; padding: 10px;">
      <img src="https://github.com/DeveloperAcademy-POSTECH/2024-NC2-A18-Widgets/assets/121593683/b027759c-44a4-4fa2-a4c0-5fd790cd1067" width="256" alt="Image 2">
    </td>
  </tr>
</table>



## Widget 이란?
앱을 열지 않고 필요한 정보를 표시하고 특정 기능을 제공하며 정보와 기능에 빠르게 접근할 수 있습니다. 


## Widget은 어디에 쓰죠?
✅  앱의 주요 목적과 관련성이 있는 간단한 정보를 표시

✅  여러크기의 위젯을 제공하는 것은 좋지만, 작은 위젯으로도 충분한 내용을 큰 위젯으로 확장하는 것은 지양 ( 큰 위젯을 사용할 수록 추가 정보를 보여주는 것이 좋음 )

✅  사람들이 원하는 콘텐츠에 빠르게 접근할 수 있도록 위젯을 터치했을 때 해당 정보와 관련된 페이지를 띄워주는 것이 좋음

✅  위젯은 하루종일 변화하는 동적 정보를 제공하는 데에 적합

✅  위젯으로 놀라움과 즐거움을 줄 수 있으면 좋음



## iPhone Widget이 보여질 수 있는 곳 

<table style="width: 100%; table-layout: fixed;">
  <tr>
    <td style="text-align: center; padding: 10px;">
      <h3>홈화면 위젯<br>(HomeScreen Widget)</h3>
      <img src="https://github.com/DeveloperAcademy-POSTECH/2024-NC2-A18-Widgets/assets/121593683/72e7b8a4-d516-49b7-8990-3ae94e3f9df1" width="200" height="408">
    </td>
    <td style="text-align: center; padding: 10px;">
      <h3>잠금화면 위젯<br>(LockScreen Widget)</h3>
      <img src="https://github.com/DeveloperAcademy-POSTECH/2024-NC2-A18-Widgets/assets/121593683/d2a4eb3f-dc2f-43da-8765-81d2283917ff" width="200" height="408">
    </td>
    <td style="text-align: center; padding: 10px;">
      <h3>오늘의 화면<br>(Today View)</h3>
      <img src="https://github.com/DeveloperAcademy-POSTECH/2024-NC2-A18-Widgets/assets/121593683/a1fa9167-59b9-458d-a36b-9bdc55adb8c1" width="200" height="408">
    </td>
    <td style="text-align: center; padding: 10px;">
      <h3>위젯 스택<br>(Widget Stack)</h3>
      <img src="https://github.com/DeveloperAcademy-POSTECH/2024-NC2-A18-Widgets/assets/121593683/f5953fda-e057-4a35-b6ce-bef2bae6f596b" width="200" height="408">
    </td>
  </tr>
</table>


## Widget의 종류 
<img width="1704" alt="image" src="https://github.com/DeveloperAcademy-POSTECH/2024-NC2-A18-Widgets/assets/121593683/3cdb4621-1020-4cbe-b9fe-452c3dcdc7ce">



## LiveActivity
Live Activites는 일반 Widget 보다 좀더 실시간 현황을 표시하는데 있어 최적화 된 컴포넌트입니다. 


<img width="250" alt="image" src="https://github.com/DeveloperAcademy-POSTECH/2024-NC2-A18-Widgets/assets/121593683/0d702c03-f963-4010-a8f2-742d2052b6a8">


1. Live Activity를 위한 model을 정의합니다. 
    - `EclipseAttributes` : LiveActivity에서 보여줄 정적인 값(실시간으로 업데이트할 필요없는 값)을 정의합니다.
    - `EclipseAttributes.ContentState`  : LiveActivity에서 보여줄 동적인 값(실시간으로 변해야하는 값)을 정의합니다.
    
    ```swift
    struct EclipseAttributes: ActivityAttributes {
        public struct ContentState: Codable, Hashable {
            var progress: Double 
            var currentTime: Date 
        }
    
        var eclipseStartTime: Date
        var eclipseEndTime: Date
        var eclipseMaxTime: Date
    }
    ```
    

2. Live Activity가 보여질  View를 정의합니다. 

```swift
struct EclipseLiveActivity: Widget {
    var body: some WidgetConfiguration {
        ActivityConfiguration(for: EclipseAttributes.self) { context in
            // Lock screen/banner 에대한 UI는 여기에 정의
            DynamicAtivityForLockScreen(context: context)
            
        } dynamicIsland: { context in
            // DynamicIsland에 대한 UI는 여기에 정의
            DynamicIsland {
                // DynamicIsland를 꾹 눌렀을 때 확장되는 영역에 대한 정의
                DynamicIslandExpandedRegion(.leading) {
                   // 왼쪽 상단 area
                    
                }
                DynamicIslandExpandedRegion(.trailing) {
                    // 오른쪽 상단 area
                }
                DynamicIslandExpandedRegion(.bottom) {
                    // 아래쪽 area
                }
            } compactLeading: {
                // 다이나믹 아이랜드 센서부기준 왼쪽
            } compactTrailing: {
                // 다이나믹 아이랜드 센서부기준 오른쪽
            } minimal: {
								// 다른 다이나믹 아이랜드생겨 밀렸을 때 오른쪽에 작게 보일때 
            }
            .widgetURL(URL(string: "http://www.apple.com")) // Link type을 활용하여 해당 위젯을 눌렀을 때 앱내의 원하는 위치로 사용자를 direct
            .keylineTint(Color("ring"))  // dynamic island 주변부의 색을 결정
        }
    }
}
```

3. LiveActivity를 시작, 종료 , 업데이트를 하는 로직을 구현합니다. 
    a. 새로운 LiveActivity를 만들고 `.request` 를 통해 시작합니다. 
    
    ```swift
    private func startNewLiveActivity() {        
                
                // 정적값 설정
                let initialAttributes = EclipseAttributes(
                    eclipseStartTime: startTime,
                    eclipseEndTime: endTime,
                    eclipseMaxTime: maxTime
                )
                
                // 동적 값 설정
                let initialContentState = EclipseAttributes.ContentState(
                    progress: 0.0,
                    currentTime: Date()
                )
                // staleDate : 더이상 LivActivity가 유효하지 않은 시점을 나타냄
                let staleDate = endTime.addingTimeInterval(10) 
                // acitivity에 관련한 동적 데이터는 ActivityContent라는 wrapper 싸서 넣어줘야함
                let activityContent = ActivityContent(state: initialContentState, staleDate: staleDate)
                
              
                //  구성한 initialAttributes와 activityContent구성해서 
                // request를 통해 LiveActivity를 시작합니다. 
                let activity = try? Activity.request(attributes: initialAttributes, content: activityContent, pushType: nil)
                
            }
            
        }
    ```
    
    b. 구성한 activity에 대해 업데이트할 값을 만들고 이를 activity에 업데이트 해줍니다. 
    
    ```swift
     func updateLiveActivity() {
    
                let currentTime = Date()
                let elapsed = currentTime.timeIntervalSince(startTime)
                let duration = endTime.timeIntervalSince(startTime)
                var progress = elapsed / duration
                progress = min(max(progress, 0.0), 1.0)
    					
    						// 동적값을 새롭게 구성합니다.             
                let updatedContentState = EclipseAttributes.ContentState(
                    progress: progress,
                    currentTime: currentTime
                )
                // 만료되는 시점을 구성합니다. 
                let staleDate = eclipse.endDateTime?.addingTimeInterval(10) ?? Date().addingTimeInterval(10)
                // 새로운 CotentState를 만들어 
                let activityContent = ActivityContent(state: updatedContentState, staleDate: staleDate)
                
                // 현재 실행중인 activity에 업데이트를 해줍니다. 
                await runningActivity.update(activityContent)
             
            }
        }
    ```
    
    c. 구성한 activity를 종료합니다. 
    
    ```swift
    func endActivity() {
    					// 마지막 상태값을 구성합니다. 
                let finalContentState = EclipseAttributes.ContentState(
                    progress: 1.0,
                    currentTime: runningActivity.attributes.eclipseEndTime
                )
                let staleDate = Date().addingTimeInterval(10)
                let activityContent = ActivityContent(state: finalContentState, staleDate: staleDate)
                
                // 현재 실행중인 liveactivity를 끝냅니다. 
                await runningActivity.end(activityContent, dismissalPolicy: .immediate)
            }
     }       
    ```
    


## Widgets

- 위젯을 구성할 model을 구성합니다. 

```swift
// 위젯을 구성할 데이터가진 struct
struct SimpleEntry: TimelineEntry {
    let date: Date
    let daysUntilEclipse: Int?
    let moonPhase: String
    let configuration: ConfigurationAppIntent
}
```

- 위젯의 디폴트 상태, 미리보기 상태, 값의 업데이트 방법을 정의합니다. 

```swift
struct Provider: AppIntentTimelineProvider {

    // 이 메서드는 위젯이 아직 데이터를 로드하지 않았을 때 표시할 기본 뷰를 제공합니다. 빠르게 로드되며, 임시 데이터를 사용
    func placeholder(in context: Context) -> SimpleEntry {
       
    }

    // 이 메서드는 위젯 갤러리에서 또는 빠른 미리보기가 필요할 때 호출됩니다. 현재 상태의 스냅샷을 제공
    func snapshot(for configuration: ConfigurationAppIntent, in context: Context) async -> SimpleEntry {
        
        
    }
    
    // 위젯에 표시할 정보 업데이트를 위한 메서드
    func timeline(for configuration: ConfigurationAppIntent, in context: Context) async -> Timeline<SimpleEntry> {
      
    }

}
```

- 위젯의 뷰를 구성합니다. (각각의 WidgetFamily에 대해 구현) 

```swift
struct EclipseWidgetEntryView: View {
    @Environment(\.widgetFamily) var family: WidgetFamily
    var entry: Provider.Entry

    var body: some View {
        switch family {
        case .systemSmall:
            SmallEclipseWidgetView(entry: entry)
        case .systemMedium:
            MediumEclipseWidgetView(entry: entry)
        case .systemLarge:
            LargeEclipseWidgetView(entry: entry)
        case .accessoryCircular:
            AccessoryCircularEclipseWidgetView(entry: entry)
        case .accessoryRectangular:
            AccessoryRectangularEclipseWidgetView(entry: entry)
        case .accessoryInline:
            AccessoryInlineEclipseWidgetView(entry: entry)
        default:
            SmallEclipseWidgetView(entry: entry)
        }
    }
}
```
- 위젯을 구성합니다. 

```swift
struct EclipseWidget: Widget {
    let kind: String = "DalADalAWidget"

    var body: some WidgetConfiguration {
        AppIntentConfiguration(kind: kind, intent: ConfigurationAppIntent.self, provider: Provider()) { entry in
            EclipseWidgetEntryView(entry: entry)
                .containerBackground(for: .widget){
                    LinearGradient(colors: [Color("widgetback"), Color("widgetback2")], startPoint: .top, endPoint: .bottom)
                }
        }
        .configurationDisplayName("Eclipse Widget")
        .description("Shows the days until the next eclipse and the current moon phase.")
        // Widget family 중 현재 app에서 지원할 widget을 선택 
        .supportedFamilies([.systemSmall, .systemMedium, .systemLarge,  .accessoryCircular, .accessoryRectangular, .accessoryInline])
    }
}
```


## 기술 참고 사항

<aside>
💡 App이 백그라운드 상태가 되면 앱으로부터 LiveActivity의 값을 업데이트 할 수 없습니다.

</aside>

- app이 포어그라운드 상태에 있는 경우, 앱을 통해 LiveActivity 값을 변경할 수 있습니다.
- 실시간 현황을 표시하기 위한 컴포넌트가 별도로 존재합니다. 
Text 또는 ProgressView 는 iOS 16이상에서 range를 통해 값을 업데이트 할 수 있습니다.
- Background Task는 Music, Carplay, Map과 같이 실시간 현황이 중요한 어플의 경우만 허용합니다.
- App이 백그라운드 상태에 있을 때에도 실시간으로 현황을 업데이트 해주기 위해서는 push notification을 통해서 서버를 통해 값을 업데이트 할 수 있습니다.
- Info plist에  `Supports Live Activities` key 값을 추가해야합니다.



















